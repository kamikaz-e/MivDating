# Инструкция по тестированию системы фильтрации RAG

## Быстрый старт

### Шаг 1: Запуск приложения
1. Убедитесь, что Ollama запущена и доступна
2. Соберите и запустите приложение:
   ```bash
   ./gradlew installDebug
   ```

### Шаг 2: Индексация документов
1. Откройте экран "RAG Document Index"
2. Нажмите кнопку "▶️ Индексировать книги"
3. Дождитесь завершения индексации

### Шаг 3: Тестирование без фильтра
1. Введите тестовый запрос, например: "главный герой"
2. Нажмите на иконку поиска
3. Запомните количество и качество результатов

### Шаг 4: Тестирование с фильтром
1. В разделе "Настройки фильтра релевантности":
   - Установите порог: **0.70**
   - Включите "Использовать фильтр"
2. Выполните тот же запрос
3. Обратите внимание на:
   - Сколько результатов отфильтровано
   - Средний score результатов
   - Качество оставшихся результатов

### Шаг 5: Режим сравнения
1. Выключите "Использовать фильтр"
2. Включите "Режим сравнения (с фильтром и без)"
3. Выполните поиск
4. Сравните результаты:
   - Количество результатов без фильтра vs с фильтром
   - Разницу в релевантности
   - Статистику фильтрации

## Тестовые сценарии

### Сценарий 1: Проверка порога фильтрации

**Цель:** Убедиться, что порог корректно отсекает нерелевантные результаты

**Шаги:**
1. Выполните поиск по запросу без фильтра
2. Запомните минимальный и максимальный score
3. Включите фильтр с порогом 0.70
4. Выполните тот же поиск
5. Проверьте, что все результаты имеют score >= 0.70

**Ожидаемый результат:**
- Все отфильтрованные результаты имеют score выше порога
- Количество результатов уменьшилось
- Средний score увеличился

### Сценарий 2: Тестирование reranking

**Цель:** Проверить влияние reranking на порядок результатов

**Шаги:**
1. Включите режим сравнения
2. Выключите "Reranking по длине контента"
3. Выполните поиск, запомните порядок результатов
4. Включите "Reranking по длине контента"
5. Выполните тот же поиск
6. Сравните порядок результатов

**Ожидаемый результат:**
- Результаты с оптимальной длиной (~500 символов) поднялись выше
- Очень короткие или очень длинные результаты опустились

### Сценарий 3: Разные пороги

**Цель:** Понять влияние разных порогов на результаты

**Тестовый запрос:** "путешествие"

**Шаги:**
1. Протестируйте с порогом **0.90** (очень строгий)
   - Ожидается: 0-2 результата, очень высокая релевантность
2. Протестируйте с порогом **0.70** (строгий)
   - Ожидается: 3-5 результатов, высокая релевантность
3. Протестируйте с порогом **0.50** (средний)
   - Ожидается: 5-8 результатов, средняя релевантность
4. Протестируйте с порогом **0.30** (мягкий)
   - Ожидается: 8-10 результатов, низкая релевантность

**Рекомендация:** Оптимальный порог обычно находится в диапазоне 0.65-0.75

### Сценарий 4: Сравнение качества ответов

**Цель:** Сравнить качество итоговых ответов с фильтром и без

**Подготовка:** Подготовьте несколько тестовых вопросов:
1. "Кто главный герой?"
2. "Где происходит действие?"
3. "Какие события происходят?"

**Шаги для каждого вопроса:**
1. Включите режим сравнения
2. Выполните поиск
3. Оцените результаты **без фильтра:**
   - Есть ли нерелевантные результаты?
   - Какой процент результатов действительно полезен?
4. Оцените результаты **с фильтром:**
   - Все ли результаты релевантны?
   - Не потеряли ли важную информацию?
5. Сделайте вывод о полезности фильтра для данного запроса

### Сценарий 5: Граничные случаи

**Цель:** Проверить работу системы в нестандартных ситуациях

**Тесты:**
1. **Очень специфичный запрос:**
   - Запрос: "точная цитата из книги"
   - Порог: 0.85
   - Ожидается: 0-1 результат с очень высоким score

2. **Очень общий запрос:**
   - Запрос: "история"
   - Порог: 0.60
   - Ожидается: много результатов, широкий разброс score

3. **Нерелевантный запрос:**
   - Запрос: "квантовая физика" (если в документах нет такой темы)
   - Порог: 0.70
   - Ожидается: 0 результатов или очень мало с низким score

## Метрики для оценки

### Количественные метрики
- **Процент отфильтрованных результатов:** `(originalCount - finalCount) / originalCount * 100%`
- **Улучшение среднего score:** `(avgScoreWithFilter - avgScoreWithoutFilter) / avgScoreWithoutFilter * 100%`

### Качественные метрики
Для каждого результата оцените (1-5):
- **Релевантность:** Насколько результат отвечает на запрос?
- **Полнота:** Есть ли вся необходимая информация?
- **Точность:** Нет ли в результате лишней информации?

## Рекомендуемые настройки

### Для разных типов запросов

| Тип запроса | Порог | Reranking | Пример |
|-------------|-------|-----------|---------|
| Фактический вопрос | 0.75-0.85 | Выкл | "Когда началась война?" |
| Концептуальный поиск | 0.65-0.75 | Вкл | "Темы любви в романе" |
| Исследовательский | 0.55-0.65 | Вкл | "Персонажи книги" |
| Широкий поиск | 0.45-0.55 | Вкл | "События" |

## Чек-лист тестирования

- [ ] Приложение успешно собирается и запускается
- [ ] Индексация проходит без ошибок
- [ ] Поиск без фильтра работает
- [ ] Поиск с фильтром работает
- [ ] Режим сравнения работает
- [ ] Слайдер порога изменяет результаты
- [ ] Reranking влияет на порядок результатов
- [ ] Метрики отображаются корректно
- [ ] Статистика фильтрации правильная
- [ ] UI корректно обновляется при изменении настроек

## Известные ограничения

1. **Производительность:** Фильтрация выполняется на клиенте, может быть медленной для больших объемов
2. **Оптимальный порог:** Зависит от качества эмбеддингов и специфики документов
3. **Length boost:** Эффективен только для документов с разнообразной длиной чанков

## Отчет о тестировании

После тестирования рекомендуется заполнить:

```
Дата тестирования: _________________
Версия приложения: _________________

Результаты:
1. Работа без фильтра: ☐ OK ☐ Проблемы: _______________
2. Работа с фильтром: ☐ OK ☐ Проблемы: _______________
3. Режим сравнения: ☐ OK ☐ Проблемы: _______________
4. Настройка порога: ☐ OK ☐ Проблемы: _______________
5. Reranking: ☐ OK ☐ Проблемы: _______________

Рекомендуемый порог для текущих документов: _______

Общая оценка улучшения качества (1-10): _______

Комментарии:
_________________________________________________
_________________________________________________
```

## Обратная связь

Если вы обнаружили проблемы или у вас есть предложения по улучшению, пожалуйста, документируйте их с указанием:
- Описания проблемы/предложения
- Шагов для воспроизведения
- Ожидаемого поведения
- Фактического поведения
- Скриншотов (если применимо)
