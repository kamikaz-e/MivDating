# Руководство по улучшенной RAG системе с фильтрацией и реранкингом

## Обзор

Проект был доработан для улучшения качества результатов RAG (Retrieval-Augmented Generation) путем добавления второго этапа обработки - фильтрации и реранкинга результатов поиска.

## Что было реализовано

### 1. Система фильтрации релевантности (`RelevanceFilter`)

**Файл:** `app/src/main/kotlin/dev/kamikaze/mivdating/data/filtering/RelevanceFilter.kt`

Основные возможности:
- **Фильтрация по порогу похожести** - результаты с cosine similarity ниже заданного порога отсекаются
- **Reranking по длине контента** - опциональная функция, которая дает небольшой буст чанкам оптимальной длины (~500 символов)
- **Анализ качества результатов** - автоматический расчет метрик качества

#### Конфигурация фильтра

```kotlin
data class FilterConfig(
    val minScoreThreshold: Double = 0.5,  // Минимальный порог (0.0 - 1.0)
    val useLengthBoost: Boolean = false,   // Использовать reranking
    val maxResults: Int = 5                // Максимум результатов после фильтрации
)
```

#### Результаты фильтрации

```kotlin
data class FilteredResults(
    val results: List<SearchResult>,      // Отфильтрованные результаты
    val originalCount: Int,               // Исходное количество
    val filteredCount: Int,               // После фильтрации по порогу
    val finalCount: Int,                  // Финальное количество
    val minScore: Double?,                // Минимальный score
    val maxScore: Double?,                // Максимальный score
    val avgScore: Double,                 // Средний score
    val appliedThreshold: Double          // Примененный порог
)
```

### 2. Обновленная база данных (`VectorDatabase`)

**Файл:** `app/src/main/kotlin/dev/kamikaze/mivdating/data/storage/VectorDatabase.kt`

Добавлен новый метод:
```kotlin
fun searchSimilarWithFilter(
    queryEmbedding: List<Double>,
    topK: Int = 10,
    filterConfig: FilterConfig = FilterConfig()
): FilteredResults
```

Этот метод:
1. Выполняет обычный поиск похожих векторов
2. Применяет фильтр релевантности
3. Возвращает результаты с метриками

### 3. Обновленный сервис индексации (`IndexingService`)

**Файл:** `app/src/main/kotlin/dev/kamikaze/mivdating/data/indexing/IndexingProgress.kt`

Добавлен метод для поиска с фильтром:
```kotlin
suspend fun searchWithFilter(
    query: String,
    topK: Int = 10,
    filterConfig: FilterConfig = FilterConfig()
): FilteredResults
```

### 4. Обновленная ViewModel (`RAGViewModel`)

**Файл:** `app/src/main/kotlin/dev/kamikaze/mivdating/OllamaViewModel.kt`

Новые возможности:
- **Три режима работы:**
  1. Без фильтра - обычный поиск
  2. С фильтром - только отфильтрованные результаты
  3. Режим сравнения - показывает оба варианта одновременно

- **Настройки фильтра в состоянии:**
  - `filterThreshold` - порог отсечения (0.0 - 1.0)
  - `useFilter` - включить/выключить фильтр
  - `useLengthBoost` - включить/выключить reranking
  - `comparisonMode` - режим сравнения

- **Новые функции управления:**
  - `updateFilterThreshold(threshold: Float)`
  - `toggleFilter()`
  - `toggleLengthBoost()`
  - `toggleComparisonMode()`

### 5. Обновленный UI (`OllamaRAGScreen`)

**Файл:** `app/src/main/kotlin/dev/kamikaze/mivdating/ui/OllamaRAGScreen.kt`

#### Новые компоненты UI:

1. **FilterSettingsSection** - Настройки фильтра:
   - Слайдер для выбора порога (0.00 - 1.00)
   - Чекбокс "Использовать фильтр"
   - Чекбокс "Reranking по длине контента"
   - Чекбокс "Режим сравнения"

2. **FilteredResultsSection** - Отображение отфильтрованных результатов:
   - Статистика фильтрации
   - Список результатов

3. **ComparisonResultsSection** - Режим сравнения:
   - Наглядное сравнение количества результатов
   - Статистика фильтрации
   - Два раздела: "Без фильтра" и "С фильтром"

## Как использовать

### 1. Базовый поиск без фильтра

1. Проиндексируйте документы кнопкой "Индексировать книги"
2. Введите поисковый запрос
3. Нажмите на иконку поиска
4. Получите до 10 результатов, отсортированных по релевантности

### 2. Поиск с фильтром

1. Проиндексируйте документы
2. В разделе "Настройки фильтра релевантности":
   - Выберите порог похожести (например, 0.70)
   - Включите чекбокс "Использовать фильтр"
   - Опционально включите "Reranking по длине контента"
3. Введите поисковый запрос и выполните поиск
4. Получите отфильтрованные результаты с метриками:
   - Количество исходных результатов
   - Количество после фильтра
   - Средний score
   - Примененный порог

### 3. Режим сравнения

1. Проиндексируйте документы
2. Настройте порог фильтрации
3. Включите чекбокс "Режим сравнения (с фильтром и без)"
4. Введите запрос и выполните поиск
5. Получите наглядное сравнение:
   - Статистику: сколько результатов без фильтра vs с фильтром
   - Полные списки результатов в обоих вариантах
   - Разницу в количестве отфильтрованных результатов

## Рекомендации по настройке порога

### Значения порога и их применение:

- **0.90 - 1.00** (Очень строгий) - Только практически идентичные результаты
  - Подходит для: точного поиска, когда нужны только самые релевантные результаты
  - Недостаток: может не найти релевантные результаты

- **0.70 - 0.90** (Строгий) - Хорошо релевантные результаты
  - **Рекомендуется для большинства случаев**
  - Оптимальный баланс между качеством и количеством

- **0.50 - 0.70** (Средний) - Умеренно релевантные результаты
  - Подходит для: широкого поиска, когда нужно больше вариантов
  - Может включать менее релевантные результаты

- **0.30 - 0.50** (Мягкий) - Слабо релевантные результаты
  - Подходит для: исследовательского поиска
  - Много шума в результатах

- **< 0.30** (Очень мягкий) - Практически без фильтрации
  - Не рекомендуется использовать

### Пример использования

**Сценарий 1: Точный поиск информации**
```
Запрос: "Какая столица Франции?"
Рекомендуемый порог: 0.75-0.85
Reranking: выключен
```

**Сценарий 2: Исследовательский поиск**
```
Запрос: "Европейские города"
Рекомендуемый порог: 0.55-0.65
Reranking: включен (даст преимущество развернутым описаниям)
```

**Сценарий 3: Поиск похожих концепций**
```
Запрос: "Архитектура и строительство"
Рекомендуемый порог: 0.60-0.70
Reranking: включен
```

## Технические детали

### Алгоритм фильтрации

1. **Получение исходных результатов:**
   ```kotlin
   val rawResults = searchSimilar(queryEmbedding, topK = 10)
   ```

2. **Фильтрация по порогу:**
   ```kotlin
   val filtered = results.filter { it.score >= config.minScoreThreshold }
   ```

3. **Применение reranking (если включено):**
   ```kotlin
   val reranked = if (config.useLengthBoost) {
       applyLengthBoost(filtered)
   } else {
       filtered
   }
   ```

4. **Ограничение количества:**
   ```kotlin
   val final = reranked.take(config.maxResults)
   ```

### Формула length boost

```kotlin
val lengthRatio = contentLength / optimalLength (500 символов)

val lengthFactor = when {
    lengthRatio < 0.5  -> 0.95  // Слишком короткий
    lengthRatio > 2.0  -> 0.95  // Слишком длинный
    lengthRatio in 0.8..1.2 -> 1.05  // Оптимальная длина
    else -> 1.0
}

newScore = originalScore * lengthFactor
```

## Метрики качества

Система автоматически вычисляет следующие метрики:

1. **Количественные:**
   - Исходное количество результатов
   - Количество после фильтрации
   - Количество отброшенных результатов

2. **Score метрики:**
   - Минимальный score
   - Максимальный score
   - Средний score
   - Распределение по диапазонам

3. **Качественные:**
   - Количество релевантных результатов (score >= threshold)
   - Количество нерелевантных результатов (score < threshold)
   - Средний score релевантных
   - Средний score нерелевантных

## Архитектура решения

```
┌─────────────────────────────────────────────────────────────┐
│                      User Query                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              Generate Query Embedding                       │
│                  (OllamaClient)                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│           Vector Similarity Search (Top 10)                 │
│               (VectorDatabase)                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│              Relevance Filter & Reranker                    │
│                 (RelevanceFilter)                           │
│                                                             │
│  1. Filter by threshold                                     │
│  2. Apply length boost (optional)                           │
│  3. Limit to maxResults                                     │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│            Filtered Results + Metrics                       │
│                                                             │
│  • Final results (Top 5)                                    │
│  • Statistics                                               │
│  • Quality metrics                                          │
└─────────────────────────────────────────────────────────────┘
```

## Заключение

Реализованная система фильтрации и реранкинга позволяет:

1. **Улучшить качество результатов** - отсекая нерелевантные результаты с низким score
2. **Гибко настраивать поиск** - через порог и опции reranking
3. **Наглядно сравнивать** - влияние фильтрации на результаты
4. **Анализировать эффективность** - через автоматические метрики

Система полностью интегрирована в существующий RAG pipeline и готова к использованию.
